<!doctype html>
<html data-n-head-ssr lang="en-US" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en-US%22%7D%7D">
  <head>
    <title>Log4Shell RCE implications for Spring Security | Camphul's Blog</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta data-n-head="ssr" httpequiv="X-UA-Compatible" content="ie=edge"><meta data-n-head="ssr" data-hid="description" name="description" content="Luca Camphuisen also known as Camphul his personal blog on Github Pages."><meta data-n-head="ssr" name="format-detection" content="telephone=no"><meta data-n-head="ssr" name="apple-mobile-web-app-capable" content="yes"><meta data-n-head="ssr" name="apple-mobile-web-app-status-bar-style" content="black"><meta data-n-head="ssr" name="apple-mobile-web-app-title" content="Camphul's Blog"><meta data-n-head="ssr" data-hid="charset" charset="utf-8"><meta data-n-head="ssr" data-hid="mobile-web-app-capable" name="mobile-web-app-capable" content="yes"><meta data-n-head="ssr" data-hid="author" name="author" content="Luca Camphuisen"><meta data-n-head="ssr" data-hid="theme-color" name="theme-color" content="#1f2937"><meta data-n-head="ssr" data-hid="og:type" name="og:type" property="og:type" content="website"><meta data-n-head="ssr" data-hid="og:title" name="og:title" property="og:title" content="Camphul's Blog on Github Pages"><meta data-n-head="ssr" data-hid="og:site_name" name="og:site_name" property="og:site_name" content="Camphul's Blog on Github Pages"><meta data-n-head="ssr" data-hid="og:description" name="og:description" property="og:description" content="Luca Camphuisen, also known as Camphul his personal Github Pages Blogging site."><base href="/"><link data-n-head="ssr" rel="shortcut icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tailwindcss/typography@0.4.0/dist/typography.min.css" integrity="sha256-1N7QO4ZmJwKGUSQgvYQOhPQrTlEWHqaSScabMik+Bks=" crossorigin="anonymous"><link data-n-head="ssr" data-hid="shortcut-icon" rel="shortcut icon" href="/_nuxt/icons/icon_64x64.673a7a.png"><link data-n-head="ssr" data-hid="apple-touch-icon" rel="apple-touch-icon" href="/_nuxt/icons/icon_512x512.673a7a.png" sizes="512x512"><link data-n-head="ssr" rel="manifest" href="/_nuxt/manifest.62100d05.json" data-hid="manifest"><link rel="preload" href="/_nuxt/c421b9e.js" as="script"><link rel="preload" href="/_nuxt/2d9bd8e.js" as="script"><link rel="preload" href="/_nuxt/css/abc88df.css" as="style"><link rel="preload" href="/_nuxt/b62e7cb.js" as="script"><link rel="preload" href="/_nuxt/css/56e063c.css" as="style"><link rel="preload" href="/_nuxt/ee18d82.js" as="script"><link rel="preload" href="/_nuxt/0919773.js" as="script"><link rel="stylesheet" href="/_nuxt/css/abc88df.css"><link rel="stylesheet" href="/_nuxt/css/56e063c.css"><link rel="preload" href="/_nuxt/static/1639572630/a/log4shell-spring-security-implications/state.js" as="script"><link rel="preload" href="/_nuxt/static/1639572630/a/log4shell-spring-security-implications/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1639572630/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="antialiased text-gray-900"><nav class="pl-2 flex fixed w-full items-center justify-between px-6 h-16 bg-gray-800 z-10"><div class="flex-shrink-0 flex items-start"><button aria-label="Open Menu" class="mr-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="white" class="h-8 w-8"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button> <a href="/index"><span class="pl-2 flex w-full justify-center items-center"><img id="camphul-logo" content="eager" alt="logo" src="/logo.png" class="h-8 w-auto"> <p class="pl-2 font-medium"><span class="invisible font-medium text-lg font-sans md:text-xl md:visible md:text-white justify-center md:font-bold">Camphul</span></p></span></a></div> <div class="relative flex items-center justify-end h-16 w-full"><div class="absolute inset-y-0 right-0 flex items-center pr-0 sm:static sm:inset-auto sm:ml-6 sm:pr-0"><a href="https://github.com/Camphul/Camphul" target="_blank" alt="Github link" class="inline-flex items-center py-2 bg-gray-800 p-2 mr-0 rounded-md text-gray-300 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 transition ease-in-out duration-100"><svg fill="currentColor" viewBox="0 0 20 20" class="h-5 w-5 text-gray-500"><path fill-rule="evenodd" d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z" clip-rule="evenodd"></path></svg> <span class="pl-1">View on GitHub</span></a></div> <aside class="transform top-0 left-0 w-64 bg-gray-800 fixed h-full overflow-auto ease-in-out transition-all duration-300 z-30 -translate-x-full"><span class="flex w-full items-center p-4 bg-gray-800"><button aria-label="Open Menu" class="mr-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="white" class="h-8 w-8"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button> <a href="/index" class="text-white font-sans text-lg md:text-xl"><span class="pl-2 flex w-full justify-center items-center"><img id="camphul-logo" content="eager" alt="logo" src="/logo.png" class="h-8 w-auto"> <p class="pl-2 font-medium">
          Camphul
        </p></span></a></span> <span class="flex items-center p-4 bg-gray-800 p-1 text-gray-300 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 transition ease-in-out duration-200"><span class="mr-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></span> <span>Home</span></span>  <div class="fixed bottom-0 w-full"><span class="flex items-center p-4 bg-gray-800 p-1 text-gray-300 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 transition ease-in-out duration-200"><span class="mr-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></span> <span>Install to Homescreen</span></span></div></aside></div></nav> <div class="px-4 py-20 md:py-24 max-w-3xl mx-auto sm:px-6 sm:py-12 lg:max-w-4xl lg:py-16 lg:px-8 xl:max-w-6xl"><article><div class="space-y-10 sm:space-y-12 lg:space-y-20 xl:space-y-24"><div class="prose prose-sm sm:prose lg:prose-lg xl:prose-2xl mx-auto nuxt-content"><h1 id="implications-of-log4shell-in-spring-security"><a href="#implications-of-log4shell-in-spring-security" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Implications of Log4Shell in Spring Security</h1>
<p>In this article we will research the logging implementation used in Spring Security and find out if there are any possible ways of unauthorized entry into a Spring application using the recently published Log4Shell RCE.</p>
<p>I wrote this in a hurry and this will contain spelling and grammar mistakes. Please dont mind some words missing and/or being misplaced.</p>
<p>Please factcheck my research and check with Spring's statements regarding the known CVE's. Use your own common sense to see if any of your applications are vulnerable. The Dutch NCSC(national cyber security center) have <a href="https://github.com/NCSC-NL/log4shell/tree/main/software" rel="nofollow noopener noreferrer" target="_blank">an extensive list of applications</a> and their vulnerability status.</p>
<p>Log4Shell is known as <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-44228" rel="nofollow noopener noreferrer" target="_blank">CVE-2021-44228</a> and allows RCE by loading an external resource for logging message parameter lookup (comparable to a string format function).
In the case of Log4Shell the lookup may end up classloading the given resource through a combination of JNDI and LDAP/RMI/DNS.</p>
<p>Spring based web-applications have integrated these vulnerable libraries in as way of logging.
This article want to research deeper into the Log4j exploit and see if it is possible to execute remote code and/or retrieve information secured on an endpoint by Spring Security.</p>
<p><strong>UPDATE AS OF 15TH OF DECEMBER</strong></p>
<p>I was on the right path of finding another logging related vuln but had too much other work to do. I was on the right path as of December 13th when I discussed a possible vuln that used MDC and non-default configurations for logging patterns.
Mostly enterprises would be affected by this I am assuming due to the nature of the MDC feature(cant use ThreadLocal in distributed systems lol).</p>
<p>My researech predictions were right. <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-45046" rel="nofollow noopener noreferrer" target="_blank">CVE-2021-45046</a> is currently being analysed. This bypasses the previous mitigations and might have a bigger attack surface across the entire globe(thank u Larry Ellison for the 3 billion java devices lol).
I am hoping that this stays limited to log4j and doesnt apply to Slf4j and logback.</p>
<p>This article will be updated soon but here's a snippet of the conversation I had on the 13th regarding possible exploitation of the MDC feature if a non default configuration for pattern layout was used.
The chat is in dutch and I'm too busy to make a translation for any english speakers right now. Use google translate or something.
<img alt="Whatsapp conversation regarding MDC exploitation" src="/010_mdc_possible_vector.jpg" title="Whatsapp conversation regarding MDC exploitation when a non default patternlayout is used"></p>
<h2 id="hypothesis-and-prerequisites"><a href="#hypothesis-and-prerequisites" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Hypothesis and prerequisites</h2>
<p>For my attempt at RCE on a Spring (Boot) application which has Spring Security enabled the following requirements must be met:</p>
<ul>
<li>The application runs on a vulnerable version of Java 8</li>
<li>No mitigations such as msglookup options have been enabled</li>
<li>Incase the application runs under a system service/unit the user that it's ran under must have access to a shell(or I might try sabotaging Spring Security at runtime allowing for data to be leaked)</li>
<li>A security filter within the Spring Security filter chain logs user input before the client request is authorized or authenticated(headers/query parameters/user agent/etc...) or there's a public endpoint which does the same.</li>
<li>The Spring libraries log directly using log4j2, and not with a pluggable logging api such as Slf4j2(reasons of which will be explained later)</li>
<li>The log4j log message will still be parsed and a lookup must still occur even when the logging level is configured to ignore debug logs(this will be the main focus due to the obsessive debug logging at Spring Security)</li>
<li>The firewall of the system running the Spring application must not block the loading of the target payload.</li>
</ul>
<h2 id="log4j2-and-slf4j"><a href="#log4j2-and-slf4j" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Log4j2 and Slf4j</h2>
<p><a href="http://www.slf4j.org/" rel="nofollow noopener noreferrer" target="_blank">SLF4j</a> is a facade/abstraction which allows the end user to plug in the desired logging framework.
In most cases the default option would be Log4j2(especially in Spring).</p>
<p><strong>TODO: explain how slf4j doesnt format messages/do lookups if loglevel is not met</strong></p>
<h2 id="our-demo-spring-app"><a href="#our-demo-spring-app" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Our demo Spring app</h2>
<p>A spring boot application with spring web, security and devtools is created from the initializer tool.</p>
<p>It is configured with an in-memory user database and stateless auth with http basic.
Three endpoints have been setup:</p>
<ol>
<li>/public which has permitAll/no security</li>
<li>/private which requires the user to have role USER</li>
<li>/escalated which requires the user to have role MANAGER</li>
</ol>
<p>A script called <code>testcalls.sh</code> has been made which does various curl api calls to automate the research.
All resources can be found in my <a href="https://github.com/Camphul/log4shell-spring-framework-research" rel="nofollow noopener noreferrer" target="_blank">research repository</a>.</p>
<p>Our first run without any configuration changes in <code>application.properties</code> does not log cause any log output to be shown in the console(and denies access to our unauthorized requests).</p>
<p>The one thing it does tell us is the security chain in use:</p>
<div class="nuxt-content-highlight"><pre class="language-text line-numbers"><code>Will secure any request with [org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@21fb8b7d, org.springframework.security.web.context.SecurityContextPersistenceFilter@18a211ed, org.springframework.security.web.header.HeaderWriterFilter@1c0db917, org.springframework.security.web.authentication.logout.LogoutFilter@7254abd2, org.springframework.security.web.authentication.www.BasicAuthenticationFilter@330c3bc, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@590a3aa5, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@3f0647ee, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@7fb8211f, org.springframework.security.web.session.SessionManagementFilter@5abfcd36, org.springframework.security.web.access.ExceptionTranslationFilter@66fea064, org.springframework.security.web.access.intercept.FilterSecurityInterceptor@7e18ff72]
</code></pre></div>
<p>This this makes it easier to see where our authentication takes place. We have:</p>
<ol>
<li>WebAsyncManagerIntegrationFilter</li>
<li>SecurityContextPersistenceFilter</li>
<li>HeaderWriterFilter</li>
<li>LogoutFilter</li>
<li>BasicAuthenticationFilter</li>
<li>RequestCacheAwareFilter</li>
<li>SecurityContextHolderAwareRequestFilter</li>
<li>AnonymousAuthenticationFilter</li>
<li>SessionManagementFilter</li>
<li>FilterSecurityInterceptor</li>
</ol>
<p>To make our intial search easier the logging level for spring security will be set to <code>logging.level.org.springframework.security=DEBUG</code></p>
<h2 id="finding-a-possible-point-of-entry"><a href="#finding-a-possible-point-of-entry" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Finding a possible point of entry</h2>
<p>Accessing a public endpoint without authentication yields the following debug logs:</p>
<div class="nuxt-content-highlight"><pre class="language-text line-numbers"><code>2021-12-13 11:25:09.212 DEBUG 137096 --- [nio-8080-exec-1] o.s.security.web.FilterChainProxy        : Securing GET /public
2021-12-13 11:25:09.217 DEBUG 137096 --- [nio-8080-exec-1] s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to empty SecurityContext
2021-12-13 11:25:09.220 DEBUG 137096 --- [nio-8080-exec-1] o.s.s.w.a.AnonymousAuthenticationFilter  : Set SecurityContextHolder to anonymous SecurityContext
2021-12-13 11:25:09.227 DEBUG 137096 --- [nio-8080-exec-1] o.s.s.w.a.i.FilterSecurityInterceptor    : Authorized filter invocation [GET /public] with attributes [permitAll]
2021-12-13 11:25:09.227 DEBUG 137096 --- [nio-8080-exec-1] o.s.security.web.FilterChainProxy        : Secured GET /public
2021-12-13 11:25:54.126 DEBUG 137096 --- [nio-8080-exec-1] s.s.w.c.SecurityContextPersistenceFilter : Cleared SecurityContextHolder to complete request
</code></pre></div>
<p>No possible way of entry to be seen. However, we are free to pass a query parameter. The logs will then include client input:</p>
<div class="nuxt-content-highlight"><pre class="language-text line-numbers"><code>2021-12-13 11:28:04.934 DEBUG 137096 --- [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Securing GET /public?evilparam=RCEstring
2021-12-13 11:28:04.935 DEBUG 137096 --- [nio-8080-exec-2] s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to empty SecurityContext
2021-12-13 11:28:04.935 DEBUG 137096 --- [nio-8080-exec-2] o.s.s.w.a.AnonymousAuthenticationFilter  : Set SecurityContextHolder to anonymous SecurityContext
2021-12-13 11:28:04.936 DEBUG 137096 --- [nio-8080-exec-2] o.s.s.w.a.i.FilterSecurityInterceptor    : Authorized filter invocation [GET /public?evilparam=RCEstring] with attributes [permitAll]
2021-12-13 11:28:04.936 DEBUG 137096 --- [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Secured GET /public?evilparam=RCEstring
</code></pre></div>
<p>The same happens even when we attempt to call a secured endpoint by an unauthorized client:</p>
<div class="nuxt-content-highlight"><pre class="language-text line-numbers"><code>2021-12-13 11:30:04.200 DEBUG 137096 --- [nio-8080-exec-3] o.s.security.web.FilterChainProxy        : Securing GET /private?evilparam=RCEstring
2021-12-13 11:30:04.201 DEBUG 137096 --- [nio-8080-exec-3] s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to empty SecurityContext
2021-12-13 11:30:04.201 DEBUG 137096 --- [nio-8080-exec-3] o.s.s.w.a.AnonymousAuthenticationFilter  : Set SecurityContextHolder to anonymous SecurityContext
2021-12-13 11:30:04.202 DEBUG 137096 --- [nio-8080-exec-3] o.s.s.w.a.i.FilterSecurityInterceptor    : Failed to authorize filter invocation [GET /private?evilparam=RCEstring] with attributes [hasRole('ROLE_USER')]
2021-12-13 11:30:04.206 DEBUG 137096 --- [nio-8080-exec-3] s.w.a.DelegatingAuthenticationEntryPoint : Trying to match using RequestHeaderRequestMatcher [expectedHeaderName=X-Requested-With, expectedHeaderValue=XMLHttpRequest]
2021-12-13 11:30:04.206 DEBUG 137096 --- [nio-8080-exec-3] s.w.a.DelegatingAuthenticationEntryPoint : No match found. Using default entry point org.springframework.security.web.authentication.www.BasicAuthenticationEntryPoint@6fa4382
2021-12-13 11:30:04.207 DEBUG 137096 --- [nio-8080-exec-3] s.s.w.c.SecurityContextPersistenceFilter : Cleared SecurityContextHolder to complete request
2021-12-13 11:30:04.211 DEBUG 137096 --- [nio-8080-exec-3] o.s.security.web.FilterChainProxy        : Securing GET /error?evilparam=RCEstring
2021-12-13 11:30:04.212 DEBUG 137096 --- [nio-8080-exec-3] s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to empty SecurityContext
2021-12-13 11:30:04.212 DEBUG 137096 --- [nio-8080-exec-3] o.s.s.w.a.AnonymousAuthenticationFilter  : Set SecurityContextHolder to anonymous SecurityContext
2021-12-13 11:30:04.212 DEBUG 137096 --- [nio-8080-exec-3] o.s.security.web.FilterChainProxy        : Secured GET /error?evilparam=RCEstring
2021-12-13 11:30:04.276 DEBUG 137096 --- [nio-8080-exec-3] s.s.w.c.SecurityContextPersistenceFilter : Cleared SecurityContextHolder to complete request
</code></pre></div>
<p>When doing the same request but with httpbasic through curl we still get a similar logging output:</p>
<div class="nuxt-content-highlight"><pre class="language-text line-numbers"><code>2021-12-13 11:47:20.552 DEBUG 137096 --- [nio-8080-exec-4] o.s.security.web.FilterChainProxy        : Securing GET /private?evilparam=RCEstring
2021-12-13 11:47:20.553 DEBUG 137096 --- [nio-8080-exec-4] s.s.w.c.SecurityContextPersistenceFilter : Set SecurityContextHolder to empty SecurityContext
2021-12-13 11:47:20.809 DEBUG 137096 --- [nio-8080-exec-4] o.s.s.a.dao.DaoAuthenticationProvider    : Authenticated user
2021-12-13 11:47:20.811 DEBUG 137096 --- [nio-8080-exec-4] o.s.s.w.a.www.BasicAuthenticationFilter  : Set SecurityContextHolder to UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=bob, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, credentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_USER]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=127.0.0.1, SessionId=null], Granted Authorities=[ROLE_USER]]
2021-12-13 11:47:20.812 DEBUG 137096 --- [nio-8080-exec-4] o.s.s.w.a.i.FilterSecurityInterceptor    : Authorized filter invocation [GET /private?evilparam=RCEstring] with attributes [hasRole('ROLE_USER')]
2021-12-13 11:47:20.812 DEBUG 137096 --- [nio-8080-exec-4] o.s.security.web.FilterChainProxy        : Secured GET /private?evilparam=RCEstring
2021-12-13 11:47:20.815 DEBUG 137096 --- [nio-8080-exec-4] s.s.w.c.SecurityContextPersistenceFilter : Cleared SecurityContextHolder to complete request
</code></pre></div>
<h2 id="breakpoints-across-the-filter-chain"><a href="#breakpoints-across-the-filter-chain" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Breakpoints across the filter chain</h2>
<p>Spring Security works by intercepting the servlet request and putting the request through a chain that can at any point return an unauthorized response.</p>
<p>Now that we know that we can get past some filter without authentication I'll place some debug breakpoints in these filter chains and see what logging technique they use.
In <code>SecurityFilterChain</code> we see our log calls being produced.</p>
<p>During the first request an instance of a Spring LogAdapter was discovered. This instance was of type Slf4j and only allowed strings and exceptions as input.
No client input. I'll just dump my findings/pics as im in quite a hurry myself. People who have the slightest bit of experience with Spring/AOP/this debacle will understand this(and the security riscs later posted).</p>
<p><img alt="LogAdapter_slf4j" src="/001_LogAdapter_slf4j.png" title="Spring's LogAdapter class"></p>
<p>We can also see that no logs are really done if the log level is not met. This is due to the performance impact on the application if it were to perform these message parsing activities even if the log level is not met.</p>
<p><img alt="Performance reasoning" src="/002_LogAdapter_slf4j_debug.png" title="Performance reasoning"></p>
<p>This is further proven by our debug breakpoint in the filter chain during a client's request.</p>
<p><img alt="Performance reasoning2" src="/003_LogAdapter_slf4j_performance_protections.png" title="Performance reasoning part 2"></p>
<p>The way the message was formatted in the filter looked suspicious to me. We can later see that Spring uses a custom logging message abstraction in their core library(ontop of I dont know how many abstractions at this point lol).</p>
<p><img alt="Spring Core Log" src="/004_LogAdapter_custom_formatter.png" title="Spring Core Log"></p>
<p>After some digging I discovered a Log formatter called <code>org.spring.core.log.LogMessage</code>.
Using this class a FormatMessage is formed from an input string and passed arguments. It uses <code>String.format(input, args...)</code> so no lookup is performed here.</p></div></div></article></div></div></div></div><script defer src="/_nuxt/static/1639572630/a/log4shell-spring-security-implications/state.js"></script><script src="/_nuxt/c421b9e.js" defer></script><script src="/_nuxt/0919773.js" defer></script><script src="/_nuxt/2d9bd8e.js" defer></script><script src="/_nuxt/b62e7cb.js" defer></script><script src="/_nuxt/ee18d82.js" defer></script>
  </body>
</html>
